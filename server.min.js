"use strict"
function checkName(e,n,o){return e.map(function(e){return e.name}).indexOf(n)>-1?checkName(e,n+"_",o):(e.push({name:n,id:o}),n)}var express=require("express"),app=express(),http=require("http").Server(app),io=require("socket.io")(http),compress=require("compression"),users=[],names=[]
app.use(compress()),app.get("/",function(e,n){n.sendFile(__dirname+"/client/public/index.html"),n.flush()}),app.get("/phaser",function(e,n){n.sendFile(__dirname+"/client/phaser/index.html"),n.flush()}),app.use(express["static"]("client/public")),io.sockets.on("connection",function(e){console.log("connected"),users.push(e),io.emit("userCount",users.length),e.on("requestUsers",function(n){var o=checkName(names,n,e.id)
e.emit("respondUsername",o),io.emit("respondUsers",names)}),e.on("challenge",function(n){var o=names[names.findIndex(function(n){return n.id===e.id})],i=names[names.findIndex(function(e){return e.name===n.challenged})]
o&&(o.inChallenge=!0),i&&(i.inChallenge=!0),n.challenger||(n.challenger={cancel:!0},o&&(o.inChallenge=void 0),i&&(i.inChallenge=void 0)),i&&io.to(i.id).emit("challenged",n.challenger),io.emit("respondUsers",names)}),e.on("meetChallenge",function(n){var o=names[names.findIndex(function(e){return e.name===n.challenger})],i=names[names.findIndex(function(e){return e.name===n.challenged})]
o&&(o.inChallenge=void 0),i&&(i.inChallenge=void 0),io.emit("respondUsers",names),o&&io.to(o.id).emit("challengeResponse",{answer:n.answer,challenged:i,challenger:o}),e.emit("challenged",!1)}),e.on("requestRoom",function(e){var n=function(n){var o=names.find(function(o){return o.name===e[n]})
o&&!function(){var n=users.find(function(e){return e.id===o.id}),i=Object.keys(n.rooms).map(function(e){return n.rooms[e]})
i.indexOf(e.challenger)<=-1&&(io.to(o.id).emit("roomResponse",e.challenger),n.join(e.challenger),setTimeout(function(){return n.emit("arrowResponse",!0)},2e3),names=names.filter(function(e){return e.id!==n.id}),io.emit("respondUsers",names))}()}
for(var o in e)n(o)}),e.on("requestWinner",function(e){io.to(e.room).emit("winnerResponse",e.winner)}),e.on("playerPos",function(n){e.broadcast.to(n.room).emit("enemyPos",n.pos)}),e.on("playerScore",function(n){e.broadcast.to(n.room).emit("enemyScore",n.score)}),e.on("playerObj",function(n){e.broadcast.to(n.room).emit("enemyObj",{obj:n.obj,type:n.type})}),e.on("playerBlur",function(n){e.broadcast.to(n.room).emit("enemyBlur")}),e.on("leaveGame",function(n){e.leave(n),io.to(n).emit("someoneLeft"),e.emit("leaveResponse")}),e.on("requestRefresh",function(){e.emit("refreshResponse")}),e.on("disconnect",function(){console.log("disconnection")
var n=users.indexOf(e)
users.splice(n,1),names=names.filter(function(n){return n.id!==e.id}),io.emit("userCount",users.length),io.emit("respondUsers",names)})}),http.listen(process.env.PORT||3e3,function(){console.log("listening on port "+(process.env.PORT||3e3))})
